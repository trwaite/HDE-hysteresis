---
title: "Backwater events"
author: "Taryn Waite"
date: "7/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(lubridate)
source("C_Q_plotting_functions.R")
source("event_functions.R")
source("C_Q_plotting_functions.R")
WQ_hourly_discharge <- read_csv("data/WQ_hourly_discharge.csv")
```

```{r function for adding events}
# adds a high-discharge event to the events tibble,
# given the data, start date, end date, and number of
# observations per day
add.event.SI <- function(data, Site, start, end, freq){
  # subset the data to include just the event
  subset <- data %>% 
    filter(dateTime >= ymd_hm(start) & dateTime <= ymd_hm(end)) %>% 
    filter(site == Site)
  # add rising or falling limb column
  peakDate <- (subset %>% slice_max(hourlyDischarge))[["dateTime"]]
  # RL if before peakDate, FL if after, peak if on peakDate
  subset <- subset %>% 
    mutate(limb = case_when(dateTime < peakDate ~ "RL",
                            dateTime > peakDate ~ "FL",
                            T ~ "peak"))
  turb <- storm_cq(data, Site, start, end, "Turb", 20, freq)
  n03 <- storm_cq(data, Site, start, end, "NO3_mgL", 20, freq)
  chl <- storm_cq(data, Site, start, end, "CHLugL", 20, freq)
  fdom <- storm_cq(data, Site, start, end, "FDOMqsu", 20, freq)
  bga <- storm_cq(data, Site, start, end, "BGAugL", 20, freq)
  return(events_SI %>% add_row(startDate = ymd_hm(start), endDate = ymd_hm(end),
                     length = as.numeric(ymd_hm(end) - ymd_hm(start)), 
                     length_loop = storm.length.loop(subset),
                     dis_change = storm.dis.change(subset),
                     dis_change_loop = storm.dis.change.loop(subset),
                     max_dis = storm.max.dis(subset),
                     avg_temp = storm.avg.temp(subset),
                     HI_turb = turb[[2]], Slope_turb = turb[[4]], area_turb = turb[[3]],
                     HI_n03 = n03[[2]], Slope_n03 = n03[[4]], area_n03 = n03[[3]],
                     HI_chl = chl[[2]], Slope_chl = chl[[4]], area_chl = chl[[3]],
                     HI_fdom = fdom[[2]], Slope_fdom = fdom[[4]], area_fdom = fdom[[3]],
                     HI_bga = bga[[2]], Slope_bga = bga[[4]], area_bga = bga[[3]]))
}
```

```{r looking at the raw data}
varNames <- c("BGAugL", "CHLugL", "FDOMqsu", "NO3_mgL", "Turb")
eventDates <- matrix(c("2016-04-25-00-00", "2016-05-24-23-59",
                       "2016-07-13-00-00", "2016-08-10-23-59",
                       "2016-06-01-00-00", "2016-06-14-23-59",
                       "2016-08-10-00-00", "2016-09-05-23-59",
                       "2016-09-06-00-00", "2016-09-20-23-59",
                       "2015-07-06-00-00", "2015-07-28-23-59",
                       "2017-06-14-00-00", "2017-06-28-23-59",
                       "2015-09-17-00-00", "2015-09-24-23-59",
                       "2015-09-09-00-00", "2015-09-17-23-59",
                       "2018-09-03-00-00", "2018-09-15-23-59",
                       "2015-08-18-00-00", "2015-09-04-23-59"), 
                     nrow = 11, ncol = 2, byrow = T)
figs <- list()
for(d in 1:11){
  figs[[d]] <- list()
  start <- eventDates[d,1]
  end <- eventDates[d,2]
  for(i in 1:5){
    y <- trend.cq.df(WQ_hourly_discharge, "SI", varNames[i],
                         start, end, 12)
    figs[[d]][[i]] <- plot.smooth.cq(y, varNames[i])
  }
}

for(d in 1:11){
  png(filename = paste0("SI_test/", eventDates[d,1], ".png"), width = 6, height = 4, 
      units = "in", res = 300)
  print(ggarrange(figs[[d]][[1]], figs[[d]][[2]], figs[[d]][[3]], figs[[d]][[4]], figs[[d]][[5]]))
  dev.off()
}

figs[[2]][[2]]
```


```{r adding events}
# initialize the tibble
events_SI <- tibble(startDate = Date(), endDate = Date(), 
                 length = numeric(), length_loop = numeric(),
                 dis_change = numeric(), dis_change_loop = numeric(),
                 max_dis = numeric(), avg_temp = numeric(),
                 HI_turb = numeric(), Slope_turb = numeric(), area_turb = numeric(),
                 HI_n03 = numeric(), Slope_n03 = numeric(), area_n03 = numeric(),
                 HI_chl = numeric(), Slope_chl = numeric(), area_chl = numeric(),
                 HI_fdom = numeric(), Slope_fdom = numeric(), area_fdom = numeric(),
                 HI_bga = numeric(), Slope_bga = numeric(), area_bga = numeric())

# add events -- this takes a long time to run 
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2016-04-25-00-00", "2016-05-24-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2016-07-13-00-00", "2016-08-10-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2016-06-01-00-00", "2016-06-14-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2016-08-10-00-00", "2016-09-05-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2016-09-06-00-00", "2016-09-20-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2015-07-06-00-00", "2015-07-28-23-59", 24)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2017-06-14-00-00", "2017-06-28-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2015-09-17-00-00", "2015-09-24-23-59", 24)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2015-09-09-00-00", "2015-09-17-23-59", 24)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2018-09-03-00-00", "2018-09-15-23-59", 12)
events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2015-08-18-00-00", "2015-09-04-23-59", 24)
 
# events with missing data
# missing 45 rows
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2016-09-20-00-00", "2016-10-15-23-59", 12)
# missing 80 rows (7/22 - end)
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2017-07-19-00-00", "2017-07-25-23-59", 24)
# missing all data
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2017-07-26-00-00", "2017-07-30-23-59", 24)
# missing all data
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2017-08-06-00-00", "2017-08-13-23-59", 24)
# missing most data (all except first 32 rows)
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2017-09-20-00-00", "2017-09-24-23-59", 24)
# missing 129 rows
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2018-06-15-00-00", "2018-07-31-23-59", 12)
# missing 227 rows (beginning until 8/25)
#events_SI <- add.event.SI(WQ_hourly_discharge, "SI", "2017-08-16-00-00", "2017-09-17-23-59", 24)

# get rid of duplicate rows
events_SI_unique <- unique(events_SI)

```

```{r reshaping the data}
events_SI_Reshaped <- events_SI_unique %>% 
  gather(key, value, -c(startDate, endDate, length, length_loop,
                        dis_change, dis_change_loop, max_dis, avg_temp)) %>% 
  separate(key, c("measure", "var"), "_") %>% 
  tidyr :: spread(measure, value)

# add columns for directions of hysteresis and slope
events_SI_Final <- events_SI_Reshaped %>% 
  mutate(H_dir = case_when(HI >= 0.05 ~ "clockwise",
                           HI <= -0.05 ~ "counter-clockwise", T ~ "none"),
         slope_dir = case_when(Slope >= 0.05 ~ "flushing",
                               Slope <= -0.05 ~ "dilution", T ~ "constant"),
         complex = case_when(area >= abs(2*HI) ~ "complex",
                             T ~ "not complex"))

write_csv(events_SI_Final, "data/events_SI")

# add other metrics
events_SI_Final2 <- events_SI_Final %>% 
  mutate(precip = mapply(totalPrecip, startDate, date(endDate), MoreArgs = list(precip2)),
         precipYear = mapply(yearTotalPrecip, startDate, MoreArgs = list(precip2)),
         prev_month_dis = mapply(prev.month.discharge, startDate, MoreArgs = list(unitDischarge,900)))

```

```{r plotting HI and slope}
# New facet label names for constituents
var.labs <- c("Cyanobacteria", "Chlorophyll", "FDOM", "Nitrate", "Turbidity")
names(var.labs) <- c("bga", "chl", "fdom", "n03", "turb")

#png(filename = "HI_slope_SI.png", 
    #width = 9, height = 6, units = "in", res = 300, bg = "transparent")
events_SI_Final %>% 
  ggplot(aes(x = HI, y = Slope)) +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  geom_point() + xlim(-1, 1) + ylim(-1, 1) +
  facet_wrap(~var, labeller = labeller(var = var.labs), nrow = 2) +
  theme_bw() + xlab("Hysteresis Index") +
  theme(plot.background = element_rect(fill = "transparent",colour = NA))
#dev.off()
```

```{r barplots of HI and slope}
# need to reorder the slope directions
events_SI_Final$slope_dir <- factor(events_SI_Final$slope_dir, 
                                 levels = c("flushing", "dilution", "constant"))

# dealing with complex hysteresis status
events_hyst_type_SI <- events_SI_Final %>% 
  mutate(hyst_type = case_when(complex == "complex" ~ "complex",
                               H_dir == "clockwise" ~ "clockwise",
                               H_dir == "counter-clockwise" ~ "counter-clockwise",
                               T ~ "no hysteresis"))
events_hyst_type_SI$hyst_type <- factor(events_hyst_type_SI$hyst_type, 
                                     levels = c("clockwise", "counter-clockwise", 
                                                "complex", "no hysteresis"))
# bar plot of hysteresis type
hiBarSI <- events_hyst_type_SI %>% 
  ggplot(aes(x = var, fill = hyst_type)) +
  geom_bar(position = position_dodge(preserve = "single")) +
  scale_fill_brewer(palette = "Paired", name = "Hysteresis Type") +
  ylab("Number of Events") + xlab("Constituent") +
  scale_x_discrete(labels = var.labs) +
  scale_y_continuous(breaks = c(2, 4, 6, 8, 10, 12)) +
  theme_bw() + 
  theme(plot.background = element_rect(fill = "transparent", colour = NA),
        legend.background = element_rect(fill = "transparent")) 

# bar plot of slope type
slopeBarSI <- events_SI_Final %>% 
  ggplot(aes(x = var, fill = slope_dir)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Paired", name = "Slope Type") +
  ylab("Number of Events") + xlab("Constituent") +
  scale_x_discrete(labels = var.labs) +
  scale_y_continuous(breaks = c(2, 4, 6, 8, 10, 12)) +
  theme_bw() + theme(plot.background = element_rect(fill = "transparent",colour = NA),
                     legend.background = element_rect(fill = "transparent")) 

# figure with both bar plots
png(filename = "HI_slope_bar_SI.png", 
    width = 6, height = 6, units = "in", res = 300, bg = "transparent")
ggarrange(hiBarSI, slopeBarSI, nrow = 2)
dev.off()
```


```{r comparison of MC and SI}
# merge MC and SI events dataframes
eventsMC_merge <- eventsFinal2[,-c(9, 10, 11)] %>% 
  mutate(site = "MC")
eventsSI_merge <- events_SI_Final %>% 
  mutate(site = "SI")

events_merge <- rbind(eventsMC_merge, eventsSI_merge)

#===== distance between MC and SI in HI-slope space =====
dist_MC_SI_temp <-events_merge %>% 
  gather(variable, value, -c(startDate, var, site)) %>%
  unite(temp, site, variable) %>%
  spread(temp, value) %>% 
  drop_na() 

dist_MC_SI_temp2 <- dist_MC_SI_temp[complete.cases(dist_MC_SI_temp),] 
dist_MC_SI_temp3 <- dist_MC_SI_temp2[-c(4,51),]

dist_MC_SI <- dist_MC_SI_temp3 %>% 
  mutate(dist = sqrt((as.numeric(MC_HI) - as.numeric(SI_HI))^2 + (as.numeric(MC_Slope) - as.numeric(SI_Slope))^2), length = as.numeric(MC_length)) 

#png(filename = "length_site_dist.png", width = 9, height = 6,
   #units = "in", res = 300, bg = "transparent")
dist_MC_SI %>% ggplot(aes(x = length, y = dist)) +
  geom_point() +
  facet_wrap(~var) +
  xlab("Event Length") + ylab("HI-Slope Euclidean Distance") +
  theme_bw() + theme(plot.background = element_rect(fill = "transparent",colour = NA),
                     legend.background = element_rect(fill = "transparent"))
#dev.off()

#png(filename = "HI_slope_site_comp.png", width = 9, height = 6,
    #units = "in", res = 300, bg = "transparent")
events_merge %>% ggplot(aes(x = HI, y = Slope, group = as.factor(startDate), col = site)) +
  geom_line(col = "grey") + 
  geom_point() + 
  facet_wrap(~var) + 
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_vline(xintercept=0, linetype="dashed", color = "black") +
  xlim(c(-1,1)) + ylim(c(-1, 1)) + xlab("Hysteresis Index") +
  scale_color_brewer(name = "Site", labels = c("Main Channel", "Backwater"), palette = "Dark2") +
  theme_bw() + theme(plot.background = element_rect(fill = "transparent",colour = NA),
                     legend.background = element_rect(fill = "transparent")) 
#dev.off()


ggplot(subset(events_SI_Final, var %in% c("chl", "bga")),
  aes(x = HI, y = Slope, group = as.factor(startDate), col = var)) +
  geom_line(col = "grey") + 
  geom_point() + 
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_vline(xintercept=0, linetype="dashed", color = "black") +
  xlim(c(-1,1)) + ylim(c(-1, 1)) + xlab("Hysteresis Index") +
  scale_color_brewer(name = "Constituent", labels = c("Chl-a", "BGA"), palette = "Dark2") +
  theme_bw() + theme(plot.background = element_rect(fill = "transparent",colour = NA),
                     legend.background = element_rect(fill = "transparent")) 

events_merge %>% ggplot(aes(x = var, y = HI, col = site)) +
  geom_boxplot()

events_merge %>% ggplot(aes(x = var, y = Slope, col = site)) +
  geom_boxplot()
```

```{r}
# multiple linear regression function for HI
reg_multi_HI_SI <- function(variable){
  subset <- events_SI_Final2 %>% 
    filter(var == variable)
  
  return((lm(subset$HI ~ 
             subset$dis_change + subset$length + subset$max_dis + subset$prev_month_dis +
             subset$avg_temp + subset$precip + subset$precipYear )))
}

# multiple linear regression function for slope
reg_multi_slope_SI <- function(variable){
  subset <- events_SI_Final2 %>% 
    filter(var == variable)
  
  return((lm(subset$Slope ~ 
             subset$dis_change + subset$length + subset$max_dis + subset$prev_month_dis +
             subset$avg_temp + subset$precip + subset$precipYear )))
}
```

```{r step AIC}
# ================ Turbidity ================
events_SI_Turb <- events_SI_Final2 %>% filter(var == "turb")
step(reg_multi_HI_SI("turb"))
summary(lm(events_SI_Turb$HI ~ events_SI_Turb$max_dis +
             events_SI_Turb$prev_month_dis + events_SI_Turb$avg_temp + 
             events_SI_Turb$precip + events_SI_Turb$precipYear))
step(reg_multi_slope_SI("turb"))
summary(lm(events_SI_Turb$Slope ~ events_SI_Turb$prev_month_dis + 
             events_SI_Turb$max_dis))

# ================ Nitrate =================
events_SI_NO3 <- events_SI_Final2 %>% filter(var == "n03")
step(reg_multi_HI_SI("n03"))
summary(lm(events_SI_NO3$HI ~ events_SI_NO3$dis_change + 
             events_SI_NO3$length + events_SI_NO3$max_dis +
             events_SI_NO3$prev_month_dis + events_SI_NO3$avg_temp +
             events_SI_NO3$precip + events_SI_NO3$precipYear))
step(reg_multi_slope_SI("n03"))
summary(lm(events_SI_NO3$Slope ~ events_SI_NO3$dis_change + 
             events_SI_NO3$length + events_SI_NO3$max_dis +
             events_SI_NO3$prev_month_dis + events_SI_NO3$avg_temp +
            events_SI_NO3$precipYear))

# ================ FDOM =================
events_SI_FDOM <- events_SI_Final2 %>% filter(var == "fdom")
step(reg_multi_HI_SI("fdom"))
summary(lm(events_SI_FDOM$HI ~ events_SI_FDOM$dis_change +
             events_SI_FDOM$max_dis + events_SI_FDOM$prev_month_dis +
             events_SI_FDOM$precip + events_SI_FDOM$precipYear))
step(reg_multi_slope_SI("fdom"))
summary(lm(events_SI_FDOM$Slope ~ events_SI_FDOM$dis_change +
             events_SI_FDOM$max_dis + events_SI_FDOM$prev_month_dis +
             events_SI_FDOM$precip + events_SI_FDOM$precipYear +
             events_SI_FDOM$length + events_SI_FDOM$avg_temp))


# ================ Chlorophyll ==================
events_SI_chl <- events_SI_Final2 %>% filter(var == "chl")
step(reg_multi_HI_SI("chl"))
summary(lm(events_SI_chl$HI ~ events_SI_chl$dis_change +
             events_SI_chl$length + events_SI_chl$max_dis +
             events_SI_chl$prev_month_dis + events_SI_chl$precip +
             events_SI_chl$precipYear))
step(reg_multi_slope_SI("chl"))
summary(lm(events_SI_chl$Slope ~ events_SI_chl$dis_change +
             events_SI_chl$prev_month_dis + events_SI_chl$precipYear))

# ================ BGA =================
events_SI_bga <- events_SI_Final2 %>% filter(var == "bga")
step(reg_multi_HI_SI("bga"))
summary(lm(events_SI_bga$HI ~ events_SI_bga$dis_change +
             events_SI_bga$length + events_SI_bga$max_dis +
             events_SI_bga$prev_month_dis + events_SI_bga$precip +
             events_SI_bga$precipYear))
step(reg_multi_slope_SI("bga"))
summary(lm(events_SI_bga$Slope ~ events_SI_bga$prev_month_dis +
             events_SI_bga$dis_change + events_SI_bga$precip))
```

